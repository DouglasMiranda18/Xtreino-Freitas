rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isSelf(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Ceo','CEO','ceo','Gerente','GERENTE','gerente'];
    }

    // users: cada usuário lê/escreve o próprio documento; Admins podem ler/escrever todos
    match /users/{userId} {
      allow read: if isSelf(userId) || isAdmin();
      allow write: if isSelf(userId) || isAdmin();
    }

    // schedules: leitura pública para contagem; escrita para logados
    match /schedules/{docId} {
      allow read: if true; // Permite leitura pública para contagem de vagas
      allow write: if isSignedIn();
    }

    // orders: leitura para admins; usuário pode ler os próprios; escrita para logados
    match /orders/{orderId} {
      allow read: if isAdmin() || (isSignedIn() && (resource.data.ownerId == request.auth.uid || resource.data.userId == request.auth.uid || resource.data.uid == request.auth.uid || resource.data.customer == request.auth.email || resource.data.buyerEmail == request.auth.email));
      allow write: if isSignedIn();
    }

    // registrations: leitura pública para contagem de vagas; usuário pode ler os próprios; admins leem tudo
    match /registrations/{regId} {
      allow read: if true; // Permite leitura pública para contagem de vagas
      allow write: if isSignedIn();
    }

    // tokens: admins podem gerenciar, usuário lê o próprio saldo
    match /tokens/{tokenId} {
      allow read, write: if isAdmin();
    }

    // digital_deliveries: usuário pode ler os próprios; admins leem tudo
    match /digital_deliveries/{deliveryId} {
      allow read: if isAdmin() || (isSignedIn() && (resource.data.customerEmail == request.auth.email));
      allow write: if isAdmin();
    }

    // config: leitura pública para configurações gerais
    match /config/{docId} {
      allow read: if true; // Permite leitura pública para configurações
      allow create: if isAdmin(); // Apenas admins podem criar configurações
      allow update: if isAdmin(); // Apenas admins podem atualizar configurações
      allow delete: if isAdmin(); // Apenas admins podem deletar configurações
    }

    // highlights: leitura pública para destaques; escrita apenas para admins
    match /highlights/{highlightId} {
      allow read: if true; // Permite leitura pública para destaques
      allow create: if isAdmin(); // Apenas admins podem criar destaques
      allow update: if isAdmin(); // Apenas admins podem atualizar destaques
      allow delete: if isAdmin(); // Apenas admins podem deletar destaques
    }

    // news: leitura pública para notícias; escrita apenas para admins
    match /news/{newsId} {
      allow read: if true; // Permite leitura pública para notícias
      allow create: if isAdmin(); // Apenas admins podem criar notícias
      allow update: if isAdmin(); // Apenas admins podem atualizar notícias
      allow delete: if isAdmin(); // Apenas admins podem deletar notícias
    }

    // products: leitura pública para produtos; escrita apenas para admins
    match /products/{productId} {
      allow read: if true; // Permite leitura pública para produtos
      allow create: if isAdmin(); // Apenas admins podem criar produtos
      allow update: if isAdmin(); // Apenas admins podem atualizar produtos
      allow delete: if isAdmin(); // Apenas admins podem deletar produtos
    }

    // product_downloads: usuário pode ler os próprios; admins leem tudo
    match /product_downloads/{downloadId} {
      allow read: if isAdmin() || (isSignedIn() && (resource.data.customerEmail == request.auth.email));
      allow write: if isAdmin();
    }

    // Admin: leitura global (qualquer coleção/documento) - apenas para admins
    match /{path=**} {
      allow read: if isAdmin();
    }
  }
}
