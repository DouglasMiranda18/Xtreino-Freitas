rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isSelf(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin','Admin','ADMIN','Ceo','CEO','ceo'];
    }
    
    function isVendedor() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['vendedor','Vendedor','VENDEDOR'];
    }
    
    function isGerente() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['gerente','Gerente','GERENTE','admin','Admin','ADMIN','Ceo','CEO','ceo'];
    }
    
    function isAuthorizedAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin','Admin','ADMIN','Ceo','CEO','ceo'] &&
        request.auth.token.email in ['cleitondouglass@gmail.com','cleitondouglass123@hotmail.com','gilmariofreitas378@gmail.com','gilmariofreitas387@gmail.com'];
    }
    
    function isAuthorizedAdminOrDesign() {
      return isSignedIn() && (
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin','Admin','ADMIN','Ceo','CEO','ceo'] &&
         request.auth.token.email in ['cleitondouglass@gmail.com','cleitondouglass123@hotmail.com','gilmariofreitas378@gmail.com','gilmariofreitas387@gmail.com']) ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['design','Design','DESIGN','Designer','DESIGNER','designer']
      );
    }
    
    function isDesign() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['design','Design','DESIGN','Designer','DESIGNER','designer'];
    }
    
    function isSocio() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['socio','Socio','SOCIO','sócio','Sócio','SÓCIO'];
    }
    
    function canReadAll() {
      return isAdmin() || isGerente() || isVendedor() || isDesign() || isSocio();
    }

    // users: cada usuário lê/escreve o próprio documento; Staff pode ler todos
    match /users/{userId} {
      allow read: if isSelf(userId) || canReadAll();
      allow write: if isSelf(userId) || isAdmin();
    }

    // schedules: leitura pública para contagem; escrita para logados
    match /schedules/{scheduleId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // orders: leitura para staff (admin/gerente/vendedor/sócio) e para o próprio usuário; escrita para logados
    match /orders/{orderId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || canReadAll());
      allow write: if isSignedIn();
    }

    // registrations: leitura para staff (admin/gerente/vendedor/sócio) e para o próprio usuário; escrita para logados
    match /registrations/{registrationId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || canReadAll());
      allow write: if isSignedIn();
    }

    // digital_deliveries: leitura para o próprio usuário e sócio; escrita para logados
    match /digital_deliveries/{deliveryId} {
      allow read: if isSignedIn() && (resource.data.customerEmail == request.auth.token.email || canReadAll());
      allow write: if isSignedIn();
    }

    // highlights: leitura pública; escrita para admins autorizados e design
    match /highlights/{highlightId} {
      allow read: if true;
      allow create, update, delete: if isAuthorizedAdmin() || isDesign();
    }

    // news: leitura pública; escrita para admins autorizados e design
    match /news/{newsId} {
      allow read: if true;
      allow create, update, delete: if isAuthorizedAdmin() || isDesign();
    }

    // config: leitura pública; escrita apenas para admins autorizados
    match /config/{configId} {
      allow read: if true;
      allow create, update, delete: if isAuthorizedAdmin();
    }

    // products: leitura pública; escrita apenas para admins autorizados
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAuthorizedAdminOrDesign();
    }

    // product_downloads: leitura para o próprio usuário; escrita para logados
    match /product_downloads/{downloadId} {
      allow read: if isSignedIn() && (resource.data.customerEmail == request.auth.token.email || isAdmin());
      allow create: if isSignedIn() && resource.data.customerEmail == request.auth.token.email && resource.data.status == 'delivered';
    }

    // product_categories: leitura pública; escrita apenas para admins autorizados
    match /product_categories/{categoryId} {
      allow read: if true;
      allow create, update, delete: if isAuthorizedAdminOrDesign();
    }

    // product_inventory: leitura para admins; escrita apenas para admins autorizados
    match /product_inventory/{inventoryId} {
      allow read: if isAdmin() || isDesign();
      allow create, update, delete: if isAuthorizedAdminOrDesign();
    }

    // product_reviews: leitura pública; escrita para usuários logados
    match /product_reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && 
        resource.data.productId is string &&
        resource.data.customerEmail == request.auth.token.email &&
        resource.data.rating >= 1 && resource.data.rating <= 5 &&
        resource.data.comment.size() <= 500;
    }

    // product_analytics: leitura para admins; escrita apenas para admins autorizados
    match /product_analytics/{analyticsId} {
      allow read: if isAdmin() || isDesign();
      allow create, update, delete: if isAuthorizedAdminOrDesign();
    }

    // product_discounts: leitura pública; escrita apenas para admins autorizados
    match /product_discounts/{discountId} {
      allow read: if true;
      allow create: if isAuthorizedAdminOrDesign() &&
        resource.data.code is string &&
        resource.data.discountType in ['percentage', 'fixed'] &&
        resource.data.value > 0 &&
        resource.data.active is bool;
    }

    // product_audit_logs: leitura para admins; escrita apenas para admins autorizados
    match /product_audit_logs/{logId} {
      allow read: if isAdmin() || isDesign();
      allow create, update, delete: if isAuthorizedAdminOrDesign();
    }

    // product_usage_stats: leitura para admins; escrita apenas para admins autorizados
    match /product_usage_stats/{statsId} {
      allow read: if isAdmin() || isDesign();
      allow create, update, delete: if isAuthorizedAdminOrDesign();
    }

    // product_backups: leitura para admins; escrita apenas para admins autorizados
    match /product_backups/{backupId} {
      allow read: if isAdmin() || isDesign();
      allow create, update, delete: if isAuthorizedAdminOrDesign();
    }
  }
}